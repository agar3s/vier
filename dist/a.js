!function(){function intersectRect(e,t){return!(t.l>e.h||t.h<e.l||t.top>e.bottom||t.bottom<e.top)}function getTotalDamage(e,t,n){return afalMatriz[e][t]*n/2}function createParticles(e,t,n,r,o){for(var a=0;a<e.D.length;a++){var i=15&e.D[a];particles.push(new Particle(e.x+(e.aa?i:15-i)*e.e,e.y+(e.D[a]>>4)*e.e,((e.aa?i:15-i)-8)*t+n,((e.D[a]>>4)-8)*t+r-2,e.e,o))}}function createBooster(e,t,n,r){boosters.push(new Booster(e,t,n,r))}function gameLoop(){ctx.clearRect(-viewport.x,viewport.y,dimensions.w,dimensions.h),xlevel.ag(),firexx.ag(),heroS.b(.8),xlevel.v(heroS),myhero.del||myhero.d();for(var t=ans.length-1;t>=0;t--)ans[t].d(),ans[t].S.ag(),loop%4==0&&ans[t].ah(),loop%2==0&&ans[t].v(),(ans[t].ai||ans[t].del)&&ans.splice(t,1);for(var t=enemies.length-1;t>=0;t--){var n=enemies[t];n.del?enemies.splice(t,1):(n.S.ag(),n.S.b(.8),xlevel.v(n.S),n.d(),loop%2==0&&n.S.ah())}for(var t=enemyans.length-1;t>=0;t--)enemyans[t].d(),enemyans[t].S.ag(),loop%4==0&&enemyans[t].ah(),loop%2==0&&enemyans[t].vHero(heroS.bounds()),(enemyans[t].ai||enemyans[t].del)&&enemyans.splice(t,1);for(var r=particles.length-1;r>=0;r--)particles[r].ag(),particles[r].d()&&particles.splice(r,1);for(var r=boosters.length-1;r>=0;r--)boosters[r].d(),xlevel.v(boosters[r].S),boosters[r].S.ag(),loop%2==0&&boosters[r].vHero(heroS.bounds()),boosters[r].del&&boosters.splice(r,1);loop%8==0&&firexx.u(),loop%64==0&&(loop=0),firexx.c(),loop%2==0&&heroS.ah(),myhero.S.x>450+viewport.x&&myhero.S.x<xlevel.w-dimensions.w+450?(viewport.x-=myhero.S.vx,xxx=-myhero.S.vx):xxx=0,yyy=0,viewport.y-viewport.oY<-dimensions.h&&myhero.S.y+viewport.oY+16*e>viewport.y+dimensions.h&&myhero.S.vy>0?yyy=-myhero.S.vy:myhero.S.y-viewport.oY<viewport.y&&(myhero.S.vy<0?yyy=-myhero.S.vy:0==myhero.S.vy&&(yyy=yOld-myhero.S.y)),viewport.y-=yyy,yOld=myhero.S.y,ctx.translate(xxx,yyy),myhero.del||(heroS.ag(),myhero.aj(),myhero.ag()),loop++,ra(gameLoop)}var doc=document;doc.get=doc.getElementById;var i,j,canvas=doc.get("c"),ctx=canvas.getContext("2d"),e=4,ppp=16,pp1=15,dimensions={w:1024,h:720},viewport={x:0,y:-720,oY:250},zoomFactor=(innerHeight-100)/dimensions.h;canvas.width=dimensions.w*zoomFactor,canvas.height=dimensions.h*zoomFactor,ctx.scale(zoomFactor,zoomFactor),ctx.translate(viewport.x,-viewport.y);var ans=[],enemyans=[],afColors=[295,205,115,25,99],basicColors=["#E0F","#09F","#1F0","#F60","yellow"],enemies=[],particles=[],platforms=[],boosters=[],currentEnemy=null;ctx.font="normal lighter 18px fantasy";for(var lastTime=0,vendors=["ms","moz","webkit","o"],x=0;x<vendors.length&&!window.requestAnimationFrame;++x)requestAnimationFrame=window[vendors[x]+"RequestAnimationFrame"];requestAnimationFrame||(requestAnimationFrame=function(e){var t=(new Date).getTime(),n=Math.max(0,16-(t-lastTime)),r=setTimeout(function(){e(t+n)},n);return lastTime=t+n,r}),ra=requestAnimationFrame;var keyMap=0,keys={37:1,38:2,39:4,40:8,65:16,83:32,68:64,32:128};doc.addEventListener("keydown",function(e){var t=e.keyCode?e.keyCode:e.which;keys[t]&&(keyMap|=keys[t],e.preventDefault())}),doc.addEventListener("keyup",function(e){var t=e.keyCode?e.keyCode:e.which;keyMap&keys[t]&&(keyMap^=keys[t],e.preventDefault())});var afalMatriz=[[0,4,2,1],[1,0,4,2],[2,1,0,4],[4,2,1,0]],ElementalSkill=function(e,t){var n=this;n.afs=e,n.charges=[],n.current=n.afs[0],n.currentQ=t;for(var r=0;r<e.length;r++)n.charges.push(t);n.an=function(e,t,r){if(n.charges[n.current]-->0){var o=new Power(n.current,2,t,r,heroS.aa?10:-10,e);ans.push(o),n.dCurrentQ()}else n.charges[n.current]=0,n.dCurrentQ()},n.dCurrentQ=function(){n.currentQ=n.charges[n.current]},n.ag=function(e,t){for(var r=0;4>r;r++)ctx.fillStyle=r==n.current&&loop%8==0?"#000":basicColors[r],ctx.fillText(""+n.charges[r],e+30+(r%2==0?35:1==r?69:0),t-35-(r%2==1?30:0==r?60:0));firexx.x=e+50,firexx.y=t-95,firexx.ag()}},Particle=function(e,t,n,r,o,a){var i=this;i.x=e,i.y=t,i.vx=n,i.vy=r,i.size=o,i.ac=a,i.life=100,i.d=function(){return i.x+=i.vx,i.vy+=.2,i.y+=i.vy,i.size*=1,--i.life<0},i.ag=function(){ctx.fillStyle="hsla("+i.ac+","+i.life+"%, "+i.life+"%, "+i.life/100+")",ctx.fillRect(i.x,i.y,i.size,i.size)}},fire="{f{g{h{i{u!$%056?@ABFORV`bcefostu~,",hero='{H{I{X{Y"#$134ACEQSVacdsu~.~1~=~@~M~P~]~^~`~a',heroan='{I{J{Y{Z"#$134ACERSVcdsu~.~0~=~?~M~O~]~^~_~`',herorun='{Y{Z{i{j"#$134ACDESVWbcdqru~)~*~+~0~9~A~Q~a~b',heroak="{Z{[{g{h{i{j{k!#$134ACESTcesu~-~0~=~?~L~O~\\~_",booster="ABCDEQSUabcdequ~,~0~<~@~L~P~\\~]~^~_~`",ab=["",'~A~>~0tqfUD2{i{h~@~=~1udVE1$#"{I{H',"B65VREA","~@~>tD2('&%{m{j{i~?~=udB651\"{J{I","~_~P~O~J~;~:~,tUB~b~a~Q~9~+~*~)uqWEA",'~`~M~?~>~=~/T2{k{[~P~J~A~;~:~0~,rdbVB1"{i{Y'],animations={i:{kf:hero,f:[0,0,0,0,0,0,0,0,0,1]},p:{kf:heroan,f:[2,3,3,2,0,-1]},r:{kf:herorun,f:[0,4,0,5,0,5,0,4,0]},j:{kf:heroak,f:[0]}},convertTobyte=function(e){for(var t=new Int16Array(ppp),n=0;n<e.length;n++)t[e[n]>>4]|=1<<pp1-(15&e[n]);return t},Sprite=function(t){var n=this;n.w=new Int16Array(ppp),n.D=loadByString(t),n.ab=[],n.ad=0,n.ac="#000",n.x=0,n.y=-720,n.vx=0,n.vy=0,n.aa=1,n.p=0,n.w=convertTobyte(n.D),n.maxVx=2.2*e,n.n=.25,n.e=0,n.hp=1,n.setPixelSize=function(e){n.e=e,n.height=n.width=16*n.e},n.setPixelSize(e),n.u=function(){for(var e=[],t=0;ppp>t;t++)for(var r=0;ppp>r;r++)n.w[t]&1<<pp1-r&&e.push(r*ppp+pp1-t);n.D=e,n.w=convertTobyte(e)},n.addFrame=function(e){n.ab.push(convertTobyte(e)),n.ad=n.ab.length-1},n.fall=function(){n.y+=n.vy,n.vy<0&&(n.p=0)},n.ah=function(){if(++n.ad>=n.ab.length&&(n.ad=0),"string"==typeof n.ab[n.ad])return n.o(n.ab[n.ad]);for(var e=[],t=0;ppp>t;t++){n.w[t]=n.w[t]^n.ab[n.ad][t];for(var r=0;ppp>r;r++)1<<pp1-r&n.w[t]&&e.push(t*ppp+r)}n.D=e},n.xi=function(){return n.x+5*n.e},n.xpi=function(){return n.x+n.e},n.xf=function(){return n.x+11*n.e},n.xpf=function(){return n.x+14*n.e},n.yi=function(){return n.y+2*n.e},n.yil=function(){return n.y+12*n.e},n.yf=function(){return n.y+16*n.e},n.b=function(e){n.vy+=e,n.vy>3*n.e&&(n.vy=3*n.e)},n.land=function(e){n.p||n.o("i"),n.vy=0,n.p=1,n.z=1,n.downed=0,n.y=e-15*n.e},n.l=function(){n.vx>0&&(n.vx=0),n.vx-=n.n,n.p&&n.o("r"),n.vx<-n.maxVx&&(n.vx=-n.maxVx),n.aa=0},n.h=function(){n.vx<0&&(n.vx=0),n.vx+=n.n,n.p&&n.o("r"),n.vx>n.maxVx&&(n.vx=n.maxVx),n.aa=1},n.forward=function(){n.aa?n.x+17*e<xlevel.w?n.h():n.g():n.x>0?n.l():n.g()},n.turn=function(){n.aa=!n.aa},n.g=function(){0!=n.vx&&(n.vx=0,n.o("i"))},n.ak=function(){(n.p||n.z)&&(n.vy=3*-n.e,n.p||(n.z=0),n.p=0,n.o("j"))},n.d=function(){n.fall(),n.x+=n.vx},n.c=function(){n.x+=n.vx},n.dY=function(){n.y+=n.vy},n.ag=function(){ctx.fillStyle=n.ac;for(var e=0;e<n.D.length;e++){var t=15&n.D[e];ctx.fillRect(n.x+(n.aa?t:15-t)*n.e,n.y+(n.D[e]>>4)*n.e,n.e,n.e)}},n.o=function(e){if(n.t!=e){n.t=e,n.ab=[];var t=animations[e].f;for(n.w=convertTobyte(loadByString(animations[e].kf)),j=0;j<t.length;j++){var r=ab[t[j]];if(-1==t[j])return n.ad=n.ab.length,n.ab.push("i");n.addFrame(loadByString(r))}}},n.hit=function(e){return n.hp-=e,n.hp<0&&(n.hp=0),0==n.hp},n.bounds=function(){return{l:n.xi(),h:n.xf(),top:n.yi(),bottom:n.yf()}}},loadByString=function(e){for(var t=0,n=e[t],r=[];n;){var o=85;"{"==n[0]&&(n=e[++t],o=0),"~"==n[0]&&(n=e[++t],o=170),r.push(n.charCodeAt()+o-33),n=e[++t]}return r},Platform=function(e,t,n){var r=this;r.x=e,r.y=t,r.width=n,r.collide=1,r.v=function(e){(e.xi()>r.x&&e.xi()<r.x+r.width||e.xf()>r.x&&e.xf()<r.x+r.width||e.xi()<r.x&&e.xf()>r.x+r.width)&&r.y>e.yil()&&r.y+5<e.yf()&&e.vy>=0?(r.collide=1,e.land(t)):r.collide=0},r.ag=function(){ctx.fillRect(r.x,r.y,r.width,5)}},Level=function(){var e=this;e.w=1024,e.h=0;var t=20;e.generateLevel=function(){platforms=[];for(var n=0;n<=e.w;n+=t){var r=n%(2*Math.PI),o=-10*Math.sin(r);e.h=o<e.h?o:e.h,platforms.push(new Platform(n,o,t))}},e.generateLevel(),e.ag=function(){var e=~~(-viewport.x/t);0>e&&(e=0);var n=e+~~(dimensions.w/t);for(n>=platforms.length&&(n=platforms.length-1),ctx.fillStyle="#A4A",i=e;n>=i;i++)platforms[i].ag()},e.v=function(e){var n=~~(e.xi()/t)-1;0>n&&(n=0);var r=~~(e.xf()/t)+1;for(r>=platforms.length&&(r=platforms.length-1),i=n;r>=i;i++)platforms[i].v(e)}},Power=function(e,t,n,r,o,a){var i=this;i.type=e,0==i.type&&(i.D=fire),1==i.type&&(i.D=fire),2==i.type&&(i.D=fire),3==i.type&&(i.D=fire),i.S=new Sprite(i.D),i.ai=0,i.ac=afColors[e],i.S.ac=basicColors[e],i.S.x=n,i.S.y=r,i.S.setPixelSize(2),i.S.vx=o,i.S.vy=a,i.S.aa=o>0,i.damage=1,i.v=function(){for(var e=enemies.length-1;e>=0;e--){var t=enemies[e].S;intersectRect(t.bounds(),i.S.bounds())&&(enemies[e].hit(i.type,i.damage),i.del=1,createParticles(i.S,2,i.S.vx/2,-3,i.ac))}},i.vHero=function(e){intersectRect(e,i.S.bounds())&&(myhero.hit(i.type,i.damage),i.del=1,createParticles(i.S,2,i.S.vx/2,-3,i.ac))},i.d=function(){i.S.c(),i.S.dY(),i.ai=i.S.x>xlevel.w||i.S.x<-10},i.ah=function(){0==i.type&&i.S.u(),1==i.type&&i.S.u()}},Booster=function(e,t,n,r){var o=this;o.type=e,o.quantity=t,o.S=new Sprite(booster),o.ac=afColors[e],o.S.ac=basicColors[e],o.S.x=n,o.S.y=r,o.S.vy=.5,o.S.p=0,o.times=256,o.d=function(){var t=loop%32==0;o.S.p?(o.del=0==o.times--,t=loop%~~(o.times/16)==0):o.S.dY(),o.S.ac=t?"#fff":basicColors[e]},o.vHero=function(e){intersectRect(e,o.S.bounds())&&(myhero.charge(o.type,o.quantity),o.del=1,createParticles(o.S,0,0,-4,o.ac))}},Enemy=function(e,t,n){var r=this;r.S=t,r.ac=afColors[e],r.S.ac="hsl("+r.ac+",100%, 50%)",r.S.o("i"),r.S.setPixelSize(7),r.S.maxVx=.9*heroS.maxVx,r.S.x=n,r.skills=new ElementalSkill([e]),r.maxhp=4,r.S.hp=4,r.q=16,r.ghostTime=100,r.del=0,r.actionpipe="",r.setActionPipe=function(e){for(var t="",n=0;n<e.length;n++){var o=e[n],a=parseInt(e.substring(n+1,n+4));if(a){n+=(""+a).length;for(var i=0;a>i;i++)t+=o}else t+=o}r.actionpipe=t},r.setActionPipe("lgajdag10jdsajd"),r.actionIndex=0,r.attack1=function(){if(r.q<=0){r.S.o("p");var e=-(r.S.x-heroS.x),t=-(r.S.y-heroS.y),n=Math.sqrt(e*e+t*t);e/=n,t/=n;var o=new Power(r.skills.current,2,r.S.x+24,r.S.y,3*e,3*t);enemyans.push(o),r.q=16}},r.follow=function(){r.S.aa=r.S.x<heroS.x,r.S.forward()},r.away=function(){r.S.aa=r.S.x>heroS.x,r.S.forward()},r.actions={f:r.S.forward,t:r.S.turn,j:r.S.ak,m:function(){},a:r.attack1,b:r.attack2,c:r.attack3,s:r.S.g,w:function(){},l:function(){r.S.p||r.actionIndex--},d:function(){r.S.p?r.S.g():(r.actionIndex--,r.S.forward())},g:r.follow,r:r.away},r.amAction=function(){var e=r.actionpipe[r.actionIndex];r.actions[e](),++r.actionIndex>=r.actionpipe.length&&(r.actionIndex=0)},r.d=function(){r.amAction(),r.S.d(),--r.q<0&&(r.q=0)},r.trigger=function(){enemies.push(new Enemy(~~(4*Math.random()),new Sprite(hero),Math.random()*xlevel.w)),enemies.push(new Enemy(~~(4*Math.random()),new Sprite(hero),Math.random()*xlevel.w)),0==~~(10*Math.random())?createBooster(4,r.maxhp,r.S.x,r.S.y):createBooster(r.skills.current,r.maxhp,r.S.x,r.S.y)},r.hit=function(e,t){r.S.hit(getTotalDamage(e,r.skills.current,t))&&!r.del&&(r.del=1,createParticles(r.S,t,0,0,r.ac),r.trigger("death")),currentEnemy=r,console.log(1-r.S.hp/r.maxhp,r.S.hp)},r.agAvatar=function(e,t){ctx.fillStyle=loop%16==0?"#000":"yellow",ctx.fillRect(e-335,t+35,300,8),ctx.fillStyle="#300",ctx.fillRect(e-334,t+36,300*(1-r.S.hp/r.maxhp)-2,6)}},heroS=new Sprite(hero);heroS.o("i");var HeroT=function(S){var m=this;m.S=S,m.S.setPixelSize(5),m.skills=new ElementalSkill([0,1,2,3],99),m.q=16,m.s=afColors[m.skills.current],m.S.ac="hsl("+m.s+",100%, 50%)",m.r=0,m.down=0,m.up=0,m.S.hp=31,m.maxhp=31,m.del=0,m.am=function(){++m.skills.current>3&&(m.skills.current=0),m.skills.dCurrentQ(),firexx.ac=basicColors[m.skills.current],m.r=5,keyMap-=64},m.prev=function(){--m.skills.current<0&&(m.skills.current=3),m.skills.dCurrentQ(),firexx.ac=basicColors[m.skills.current],keyMap-=16,m.r=-5},m.an=function(){if(m.q<=0){m.S.o("p");var e=0;m.down&&(e=7),m.up&&(e=-7),m.skills.an(e,heroS.x+24,heroS.y),m.q=16}m.S.ac="hsl("+m.s+","+m.skills.currentQ+"%, 50%)"},m.d=function(){m.S.d(),m.s+=m.r,m.s<0&&(m.s=355),m.s>355&&(m.s=5),m.s!=afColors[m.skills.current]?m.S.ac="hsl("+m.s+","+m.skills.currentQ+"%, 50%)":m.r=0,--m.q<0&&(m.q=0)},m.aj=function(){64&keyMap&&m.am(),16&keyMap&&m.prev(),m.down=8&keyMap?1:0,m.up=2&keyMap?1:0,128&keyMap&&(m.S.ak(),keyMap^=128),32&keyMap&&m.an(),1&keyMap&&m.S.x>-16?m.S.l():4&keyMap&&m.S.x+16*e<xlevel.w?m.S.h():m.S.g()},m.hit=function(e,t){heroS.hit(getTotalDamage(e,m.skills.current,t))&&!m.del&&(m.del=1,createParticles(heroS,t,0,0,m.ac))},m.charge=function(e,t){4==e?(m.S.hp+=t,m.S.hp>m.maxhp&&(m.S.hp=m.maxhp)):(m.skills.charges[e]+=t,m.skills.charges[e]>99&&(m.skills.charges[e]=99))},m.ag=function(){var vx=-viewport.x,vy=viewport.y;if(ctx.strokeStyle="yellow",ctx.fillStyle="#300",ctx.strokeRect(vx+35,vy+35,300,8),ctx.fillRect(vx+35,vy+35,300,8),ctx.fillStyle="yellow",ctx.fillRect(vx+35,vy+35,300*(m.S.hp/m.maxhp),8),m.skills.ag(vx,vy+dimensions.h),currentEnemy)with(currentEnemy)agAvatar(vx+dimensions.w,vy),del&&0==--ghostTime&&(currentEnemy=null)}},xlevel=new Level,myhero=new HeroT(heroS),firexx=new Sprite(fire);firexx.ac=basicColors[0],firexx.e=3,enemies.push(new Enemy(1,new Sprite(hero),Math.random()*xlevel.w));var loop=0,yOld=myhero.S.y;ra(gameLoop)}();